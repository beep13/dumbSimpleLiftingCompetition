{% extends "base.html" %}

{% block title %} - Admin Weekly Workout{% endblock %}

{% block content %}
<h1 class="mb-4">Admin - Weekly Workout Routine</h1>

<div class="row">
    <div class="col-md-6">
        <h2 class="mb-3">Add New Exercise</h2>
        <form method="POST" id="new-exercise-form" class="mb-4">
            <input type="hidden" name="new_exercise" value="1">
            <div class="mb-3">
                <label for="exercise_name" class="form-label">Exercise Name:</label>
                <input type="text" id="exercise_name" name="exercise_name" class="form-control" required>
            </div>
            <div class="mb-3">
                <label for="muscle_group" class="form-label">Muscle Group:</label>
                <select id="muscle_group" name="muscle_group" class="form-select" required>
                    <option value="">Select a muscle group</option>
                    {% for group in muscle_groups %}
                        <option value="{{ group }}">{{ group }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Add Exercise</button>
        </form>
    </div>

    <div class="col-md-6">
        <h2 class="mb-3">Weekly Workout Routine</h2>
        <form method="POST" id="workout-form">
            {% for day in ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'] %}
                <div class="card mb-3">
                    <div class="card-header">
                        <h3 class="mb-0">{{ day }}</h3>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="{{ day }}_name" class="form-label">Workout Name:</label>
                            <input type="text" id="{{ day }}_name" name="{{ day }}_name" class="form-control" value="{{ weekly_workouts|selectattr('day', 'equalto', day)|map(attribute='name')|first or '' }}">
                        </div>
                        <div id="{{ day }}_exercises">
                            {% set workout = weekly_workouts|selectattr('day', 'equalto', day)|first %}
                            {% if workout %}
                                {% for exercise in workout.exercises %}
                                    <div class="row mb-2">
                                        <div class="col-md-6">
                                            <select name="{{ day }}_exercise_{{ loop.index }}" class="form-select exercise-select">
                                                <option value="">Select an exercise</option>
                                                {% for group in muscle_groups %}
                                                    <optgroup label="{{ group }}">
                                                        {% for ex in exercises if ex.muscle_group == group %}
                                                            <option value="{{ ex.id }}" {% if ex.id == exercise.exercise_id %}selected{% endif %}>{{ ex.name }}</option>
                                                        {% endfor %}
                                                    </optgroup>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <input type="number" name="{{ day }}_sets_{{ loop.index }}" class="form-control" value="{{ exercise.sets }}" min="1" placeholder="Sets">
                                        </div>
                                        <div class="col-md-3">
                                            <input type="number" name="{{ day }}_reps_{{ loop.index }}" class="form-control" value="{{ exercise.reps }}" min="1" placeholder="Reps">
                                        </div>
                                    </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <button type="button" class="btn btn-secondary mt-2" onclick="addExercise('{{ day }}')">Add Exercise</button>
                        <input type="hidden" id="{{ day }}_exercise_count" name="{{ day }}_exercise_count" value="{{ workout.exercises|length if workout else 0 }}">
                    </div>
                </div>
            {% endfor %}
            <button type="submit" class="btn btn-primary">Save Weekly Routine</button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function refreshExerciseDropdowns() {
        $.get('/exercises', function(exercises) {
            
            // Group exercises by muscle group
            const groupedExercises = {};
            exercises.forEach(function(exercise) {
                if (!groupedExercises[exercise.muscle_group]) {
                    groupedExercises[exercise.muscle_group] = [];
                }
                groupedExercises[exercise.muscle_group].push(exercise);
            });

            // Update each dropdown
            $('.exercise-select').each(function() {
                const select = $(this);
                const currentValue = select.val();
                select.empty().append('<option value="">Select an exercise</option>');

                Object.keys(groupedExercises).sort().forEach(function(group) {
                    const optgroup = $('<optgroup>').attr('label', group);
                    groupedExercises[group].forEach(function(exercise) {
                        optgroup.append($('<option>', {
                            value: exercise.id,
                            text: exercise.name
                        }));
                    });
                    select.append(optgroup);
                });

                // Restore the previously selected value if it still exists
                select.val(currentValue);
            });
        });
    }

    // Refresh exercise list after adding a new exercise
    $('#new-exercise-form').on('submit', function(e) {
        e.preventDefault();
        const form = $(this);
        $.ajax({
            url: form.attr('action'),
            type: 'POST',
            data: form.serialize(),
            success: function(response) {
                alert('New exercise added successfully!');
                setTimeout(refreshExerciseDropdowns, 100);  // Delay refresh slightly
                form[0].reset();  // Clear the form
            },
            error: function(xhr, status, error) {
                alert('Error adding exercise. Please try again.');
            }
        });
    });

    // Initial load of exercise dropdowns
    $(document).ready(refreshExerciseDropdowns);

    // Function to add new exercise to a day
    function addExercise(day) {
        const container = document.getElementById(`${day}_exercises`);
        const count = container.children.length + 1;
        const div = document.createElement('div');
        div.innerHTML = `
            <select name="${day}_exercise_${count}" class="exercise-select">
                <option value="">Select an exercise</option>
            </select>
            <input type="number" name="${day}_sets_${count}" min="1" placeholder="Sets">
            <input type="number" name="${day}_reps_${count}" min="1" placeholder="Reps">
        `;
        container.appendChild(div);
        document.getElementById(`${day}_exercise_count`).value = count;
        refreshExerciseDropdowns();  // Refresh to populate the new dropdown
    }
</script>
{% endblock %}
